<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'style.css' %}" />
    <title>Document</title>
</head>
<style>
    body {

        color: rgb(81, 35, 130);
        width: 100%;
        padding: 20px;
    }
    .menu {
        position: absolute;
        top: 20px;
        right: 20px;
        border: none;
    }
    #menu_ul{
        text-align: center;
    }

    .menu_li {
        width: fit-content;
        list-style: none;
        border: 1px solid;
        margin-top: 3px;
        width:200px;
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-size: 20px;
        background-color: antiquewhite;
    }

    .menu_li:hover{
        background-color: bisque;
    }
    ul {
        list-style: none;
    }
    li {
        width: fit-content;
    }
    .online-users {
        font-weight: bold;
        border-radius: 5px;
        border-color: black;
        border-style: dashed;
        width: fit-content;
        padding: 10px;
        margin: 10px;
        min-width: 50px;
    }
    #online-users {
        margin-left: -30px;
        text-align: center;
        align-items: center;
    }

</style>
<body>
    <div class="menu">
        <ul id="menu_ul">
            <li class="menu_li"><a href="{% url 'shop' %}">shop</a></li>
            <li class="menu_li"><a href="{% url 'gameshop' %}">gameshop</a></li>
            <li class="menu_li"><a href="{% url 'settings' %}">settings</a></li>
            <li class="menu_li"><a href="{% url 'menu' %}">menu</a></li>
            <li class="menu_li"><a href="{% url 'user' username=username %}">user</a></li>
            <li class="menu_li"><a href="{% url 'global_chat' %}">global chat</a></li>
            <li class="menu_li"><a href="{% url 'tamagochi' %}">tamagochi</a></li>
            <!--<li><form action="" method="post">{% csrf_token %}<button class="logout" type="submit" name="logout">logout</button></form></li>-->
            <li class="menu_li"><a href="{% url 'logout' %}">logout</a></li>
        </ul>
    </div>

    <div class="online-users">
        <ul id="online-users"></ul>
    </div>

    <div class="knopka-div">
        <button id="knopka">Load old messages</button>
    </div>

    <div class="messages">
        <ul id="messages"></ul>
    </div>
    <div class="message-input">
        <input type="text" id="messageInput" placeholder="type your message"> 
        <button id="sendMessage">Send</button>
    </div>
</body>
    <script>
        const sessionid = "{{ sessionid }}";
        const socket = new WebSocket(`ws://127.0.0.1:8000/ws/global_chat/?sessionid=${sessionid}`);   
        const button = document.getElementById("sendMessage");

        let currentUsername = "You";
        let offset = 30; // Start after initial 30 messages

        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);

            if (data.messages) {
                const msgContainer = document.getElementById("messages");
                console.log("Loaded messages:", data.messages);
                // If this was the initial message load, replace the contents.
                // But for "load_more", we just prepend.
                if (data.offset === 30) {
                    // Initial load
                    msgContainer.innerHTML = "";  
                    data.messages.forEach(msg => {
                        appendMessage(msg.author, msg.text);
                    });
                } else {
                    // Load more (prepend)
                    [...data.messages].reverse().forEach(msg => {
                        const msgElement = document.createElement("li");
                        msgElement.textContent = `${msg.author}: ${msg.text}`;
                        msgContainer.prepend(msgElement);
                    });
                }
                offset = data.offset;
            }

            if (data.message) {
                // New message (from self or others)
                appendMessage(data.username, data.message);
            }

            if (data.online_users) {
                const userList = document.getElementById("online-users");
                userList.innerHTML = "";
                data.online_users.forEach(user => {
                    const li = document.createElement("li");
                    li.textContent = user;
                    userList.appendChild(li);
                });
            }
        };



        function appendMessage(username, message, timestamp) {
            const msgElement = document.createElement("li");
            msgElement.textContent = `${username}: ${message}`;
            document.getElementById("messages").appendChild(msgElement);
        }

        function sendMessage() {
            const input = document.getElementById("messageInput");
            const message = input.value.trim();

            if (!message) {  // Prevents empty, space-only, or null messages
                return;
            }

            if (message !== "") {
                //appendMessage(currentUsername, message); // Show message instantly

                // Send message to WebSocket
                socket.send(JSON.stringify({
                    action: "send_message",
                    message: message
                }));

                input.value = ""; // Clear input after sending
            }
        }

        document.getElementById("knopka").addEventListener("click", function () {
            socket.send(JSON.stringify({
                action: "load_more",
                offset: offset
            }));
        });

        button.addEventListener("click", sendMessage);
    </script>
</html>